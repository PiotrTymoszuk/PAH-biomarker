---
title: "Comprehensive multivariate risk modeling improves mortality risk prediction in pulmonary arterial hypertension"
subtitle: "Supplementary Material"
author: "Innsbruck PAH registry"
date: "`r format(Sys.time(), '%Y-%m-%d')`"

output: 
  bookdown::word_document2:   
    reference_docx: ms_template.docx 
    
bibliography: pah_biblio.bib
csl: frontiers-in-immunology.csl
header-includes:
  \usepackage{longtable}
  \usepackage{tabu}
  \usepackage{caption}
  \usepackage{makecell}
  \usepackage{pdflscape}
  \usepackage{array}
  \usepackage{booktabs}
  \usepackage{threeparttable}
  \usepackage{threeparttablex}
  \usepackage{wrapfig}
  \usepackage{multirow}
  \usepackage[normalem]{ulem}
  \usepackage{colortbl}
  \usepackage{xcolor}
  \usepackage{float} \floatplacement{figure}{H} \floatplacement{table}{H}
  \newcommand{\beginsupplement}{\setcounter{table}{0}  \renewcommand{\thetable}{S\arabic{table}}       \setcounter{figure}{0} \renewcommand{\thefigure}{S\arabic{figure}}}
---

```{r, setup, include = FALSE}

library(bookdown)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, dev = "cairo_pdf")


```

\newpage

\beginsupplement

# Supplementary Methods

## Data transformation, visualization, descriptive statistic

Data transformation, analysis and result visualization was accomplished by R version 4.0.5 with _tidyverse_ environment[@Wickham2019; @Wickham2016]. Figures were generated with _cowplot_ package [@Wilke2019], Supplementary Material file was built with _rmarkdown_ environment (packages _knitr_, _rmarkdown_, _flextable_ and _bookdown_) [@Xie2016]. 

For univariable survival modeling and construction of candidate risk signatures, a set of categorical `r nrow(pah_study$mod_variables)` demographic, biochemical, right-heart catheter, laboratory, ultrasound and lung function parameters recorded at PH diagnosis was used. To improve normality of some independent variables (NT-pro-BNP, RDW, TF-Sat, Ferritin) prior to survival modeling, log transformation was applied. 
For the list of modeling variables and their stratification scheme, see: __Supplementary Table \@ref(tab:tab-study-variables)__.

## Hypothesis testing, multiple comparisons

As the some of the analyzed numeric variables were non-normally distributed as checked by Shapiro-Wilk test, differences in median values of numeric variables between the study cohorts or participant clusters were investigated by Mann-Whitney test and r effect size statistic. 
Differences in frequency distribution of categorical variables between the study cohorts or participant clusters were assessed by $\chi^2$ test and Cramer's V effect size statistic. 
Explorative data analysis and hypothesis testing was accomplished with _rstatix_ package and in-house-developed tools (https://github.com/PiotrTymoszuk/ExDA).
Differences in survival between the participant clusters or participants stratified by risk score tertiles were compared by Kaplan-Meier (KM) analysis, Mentel-Henszel or log-rank test [@Harrington1982; @Therneau2000]. KM analysis and visualization of its results were done with tools provided by _survival_ and _survminer_ packages [@Kassambara2016].
For each analysis and cohort, p values were corrected for multiple comparisons with Benjamini-Hochberg method [@Benjamini1995]. 

## Univariable Cox survival modeling

Association of independent categorical and numeric variables (__Supplementary Table \@ref(tab:tab-study-variables)__) with overall survival time was assessed by series of univariable Cox proportional hazard models constructed for the Innsbruck and Linz/Vienna cohort using _survival_ package [@Therneau2000]. 
Numeric variables were median-centered (function _scale(x, center = median(x))_). To account for non-linear associations of numeric independent variables, both 1^st^ and 2^nd^ order terms were included in the Cox models. 
Significance of the hazard ratio estimates was determined by Wald Z test. P values were corrected for multiple comparisons with Benjamini-Hochberg method [@Benjamini1995]. 
Proportional hazard assumption was checked with _cox.zph()_ function (package _survival_) [@Therneau2000].
For the full modeling results, see: __Supplementary Table \@ref(tab:tab-uni-cox)__.

## Multivariable Cox survival modeling with elastic net technique

Multi-parameter Cox modeling with the set of independent categorical and numeric variables (__Supplementary Table \@ref(tab:tab-study-variables)__) was accomplished by elastic net machine learning technique and _glmnet_ package [@Friedman2010]. Data pre-processing included median centering of numeric independent variables (function _scale(x, center = median(x))_) and conversion of categorical features to dummy numeric variables (function _model.matrix()_, base R). 
To account for non-linear associations of numeric independent variables, both 1^st^ and 2^nd^ order terms were included in the elastic net model development. 
The elastic net Cox proportional hazard model was trained in the Innsbruck cohort (function _glmnet()_, alpha = 0.5). The optimal lambda parameter ($\lambda$ = `r signif(multi_cox$opt_lambda$lambda[1], 3)`) for the training cohort model construction was found by 200-repetition 10-fold cross-validation (function _cv.glmnet()_) and corresponded to the minimum of cross-validation error. 
The values of non-zero elastic net model coefficients are presented in __Figure 2A__. 
Subsequently, the elastic net model linear predictor (LP) scores were calculated for the training IBK and test Linz/Vienna cohort and their association with overall survival was assessed by univariate Cox modeling. Concordance index (C-index) and $R^2$ (measure of explained variation) were calculated with _concordance()_ (package _survival_) and _rsq()_ (package _survMisc_) functions, respectively. Modeled survival in the training and the test cohort was compared with the actual overall survival by KM method. Differences in survival between study participants stratified by the LP score tertiles were assessed by log-rank test as described above.

## Clustering of the study participants

Clustering of the study participants in the Innsbruck training cohort in respect to the variables found associated with overall survival by the elastic net Cox modeling (__Figure 2A__; `r translate_vars(unique(multi_plots$lasso_coefs$variable)) %>% paste(collapse = ', ')`) was done with the PAM algorithm (partition around medoids, function _pam()_, package _cluster_) [@Schubert2019] with the cosine distance between the study participants (function _distance()_, package _philentropy_) [@Drost2018]. Prior to clustering, the numeric variables were median centered (function _scale(x, center = median(x))_). The PAM/cosine distance clustering procedure demonstrated the superior fraction of 'explained' clustering variance (ratio of total between-cluster to total sum-of-squares) and the optimal performance in 10-fold cross-validation measured by the fraction of correct cluster assignments [@Lange2004] as compared with hierarchical clustering, k-means and self-organizing map algorithms (__Supplementary Figure S\@ref(fig:fig-cluster-qc)A__). The choice of cluster number was based on the bend of the within-cluster sum-of-squares curve (__Supplementary Figure \@ref(fig:fig-cluster-qc)B__). The importance of specific clustering features was determined by comparing the 'explained' clustering variances of the original clustering structure with the clustering objects with randomly re-shuffled clustering features [@Sonnweber2022]. Assignment of the test Linz/Vienna cohort participants to the clusters was done with a k-nearest neighbor label propagation procedure (k = 5) [@Sonnweber2022; @Leng2014; @Sahanic2021]. In-house-developed wrappers for cluster object construction, cross-validation, importance testing and semi-supervised clustering are available as development packages (_clustTools_: https://github.com/PiotrTymoszuk/clustTools and _somKernels_: https://github.com/PiotrTymoszuk/somKernels).

Differences in study variables (__Supplementary Table \@ref(tab:tab-study-variables)__) between the participant clusters were determined by Mann-Whitney or $\chi^2$ test as described above (__Supplementary Tables S\@ref(tab:tab-clust-IBK) - S\@ref(tab:tab-clust-IBK)__). Differences in overall survival between the clusters were compared with KM method and Mentel-Henszel test as described above.

# Data and code availability

The study data set is available at serious request to the corresponding author. The analysis R code was deposited on GitHub (https://github.com/PiotrTymoszuk/PAH-biomarker).

\newpage

# Supplementary Tables {#sec:tables}

```{r tab-study-variables, tab.cap = 'Study variables.'}

suppl_tables$study_vars %>% 
  flextable %>% 
  width(1, width = 2.7, unit = 'cm') %>% 
  width(2, width = 4.7, unit = 'cm') %>%
  width(3, width = 3, unit = 'cm') %>% 
  width(4, width = 1.8, unit = 'cm') %>% 
  width(5, width = 2.6, unit = 'cm') %>% 
  width(6, width = 2.2, unit = 'cm') %>% 
  footnote(1, 1, part = 'header', value = as_paragraph('Variable name in the R analysis pipeline.'), ref_symbols = '1') %>% 
  footnote(1, 3, part = 'header', value = as_paragraph('Variable name in the figures and tables.'), ref_symbols = '2') %>% 
  font(part = 'all', fontname = 'Cambria') %>% 
  fontsize(size = 10, part = 'all') %>% 
  theme_vanilla
  
```

\newpage

```{r tab-uni-cox, tab.cap = 'Results of univariable Cox modeling.'}

suppl_tables$univariable_cox %>% 
  flextable %>% 
  width(1, width = 1.4, unit = 'cm') %>% 
  width(2, width = 2.7, unit = 'cm') %>% 
  width(3:4, width = 1.3, unit = 'cm') %>%
  width(5, width = 3, unit = 'cm') %>% 
  width(6, width = 2.5, unit = 'cm') %>% 
  width(7, width = 3, unit = 'cm') %>% 
  width(8, width = 1.5, unit = 'cm') %>% 
  merge_v(1:2) %>% 
  footnote(1, 5, part = 'header', value = as_paragraph('Hazard ratio with 95% confidence interval.'), ref_symbols = '1') %>% 
  footnote(1, 7, part = 'header', value = as_paragraph('Concordance index with 95% confidence interval.'), ref_symbols = '2') %>%
  font(part = 'all', fontname = 'Cambria') %>% 
  fontsize(size = 10, part = 'all') %>% 
  theme_vanilla
  
```

\newpage

```{r tab-clust-IBK, tab.cap = 'Characteristic of the participant clusters in the Innsbruck cohort.'}

suppl_tables$clust_IBK %>% 
  flextable %>% 
  width(1, width = 2.8, unit = 'cm') %>% 
  width(2:3, width = 4.6, unit = 'cm') %>% 
  width(4, width = 2.5, unit = 'cm') %>% 
  width(5, width = 2, unit = 'cm') %>% 
  footnote(c(2:4, 6:7, 9, 11:14, 16:18, 20, 23:27), 4, part = 'body', value = as_paragraph('Mann-Whitney U test.', ref_symbols = '1')) %>% 
  footnote(c(2:4, 6:7, 9, 11:14, 16:18, 20, 23:27), 5, part = 'body', value = as_paragraph('Wilcoxon r effect size statistic.', ref_symbols = '2')) %>% 
  footnote(c(5, 8, 10, 15, 19, 21:22), 4, part = 'body', value = as_paragraph('\u03C7\u00B2 test.'), ref_symbols = '3') %>% 
  footnote(c(5, 8, 10, 15, 19, 21:22), 5, part = 'body', value = as_paragraph('Cramer V effect size statistic.'), ref_symbols = '4') %>% 
  font(part = 'all', fontname = 'Cambria') %>% 
  fontsize(size = 10, part = 'all') %>% 
  theme_vanilla
  
```

\newpage

```{r tab-clust-LZ, tab.cap = 'Characteristic of the participant clusters in the Linz/Vienna cohort.'}

suppl_tables$clust_LZ %>% 
  flextable %>% 
  width(1, width = 2.8, unit = 'cm') %>% 
  width(2:3, width = 4.6, unit = 'cm') %>% 
  width(4, width = 2.5, unit = 'cm') %>% 
  width(5, width = 2, unit = 'cm') %>% 
  footnote(c(2:4, 6:7, 9, 11:14, 16:18, 20, 23:27), 4, part = 'body', value = as_paragraph('Mann-Whitney U test.', ref_symbols = '1')) %>% 
  footnote(c(2:4, 6:7, 9, 11:14, 16:18, 20, 23:27), 5, part = 'body', value = as_paragraph('Wilcoxon r effect size statistic.', ref_symbols = '2')) %>% 
  footnote(c(5, 8, 10, 15, 19, 21:22), 4, part = 'body', value = as_paragraph('\u03C7\u00B2 test.'), ref_symbols = '3') %>% 
  footnote(c(5, 8, 10, 15, 19, 21:22), 5, part = 'body', value = as_paragraph('Cramer V effect size statistic.'), ref_symbols = '4') %>% 
  font(part = 'all', fontname = 'Cambria') %>% 
  fontsize(size = 10, part = 'all') %>% 
  theme_vanilla
  
```

\newpage

# Supplementary Figures {#sec:figures}

```{r fig-uni-cox, fig.width = 7.086614166, fig.height = 8.267716527, fig.cap = 'Univariable Cox proportional hazard modeling.'}

suppl_figures$uni_cox$plot

```

__Supplementary Figure S\@ref(fig:fig-uni-cox). Univariable Cox proportional hazard modeling.__

Association of candidate risk factors (__Supplementary Table S\@ref(tab:tab-study-variables)__) with overall survival was investigated with a series of univariable Cox proportional hazard models. Numeric independent variables were median-centered and their first and second order terms included in the models. Hazard ratio (HR) estimate significance was determined by Wald Z test and adjusted for multiple testing with Benjamini-Hochberg method. HR values with 95$\%$ confidence intervals for variables significantly associated with the survival in at least one Innsbruck (IBK) or Linz/Vienna cohort (LZ/W) were presented in a Forest plot. Numbers of complete observations and mortality are indicated under the plot.
CI: cardiac index; MCV: mean corpuscular volume; mPAP: mean pulmonary artherial pressure; NT-pro-BNP: N terminal pro brain natriuretic peptide; PVR: pulmonary vascular resistance; RAA: right atrial area; SMWD: six minute walking distance.

\newpage

```{r fig-elanet-calibration, fig.width = 7.086614166, fig.height = 3.93700787, fig.cap = 'Elastic net model linear prediction score and overall survival.'}

suppl_figures$elanet_calibration$plot

```

__Supplementary Figure S\@ref(fig:fig-elanet-calibration). Elastic net model linear prediction score and overall survival.__

The elastic net multi-parameter Cox model was developed in the training Innsbruck (IBK) cohort (__Figure 2__). Association of overall survival with the elastic net model linear prediction score in the training IBK and test Linz/Vienna (LZ/W) cohort was assessed by Kaplan-Meier analysis. Significance of the survival differences in the study participants stratified by the linear predictor score tertiles (T1: 0 - 33, T2: 34 - 66, T3: 66 - 100 percentile) was determined by log-rank test adjusted for multiple testing with Benjamini-Hochberg method. P values are shown in the plots, numbers of complete observations and mortality are indicated under the plots.

\newpage

```{r fig-cluster-qc, fig.width = 7.086614166, fig.height = 7.480314953, fig.cap = 'Development of participant clusters.'}

suppl_figures$cluster_qc$plot

```

__Supplementary Figure S\@ref(fig:fig-cluster-qc). Development of participant clusters.__

Clustering of the training Innsbruck (IBK) cohort participants in respect to the survival-associated factors identified by elastic-net modeling (__Figure 2A__) was investigated by PAM (partition around medoids) algorithm and cosine distance measure.

__(A)__ Comparison of the 'explained' clustering variance (between-cluster to total sum-of-squares) and 10-fold cross-validation (CV) correct prediction rate for clustering of the IBK cohort with various algorithms (PAM, HCl: hierarchical clustering, k-means and SOM/HCl: combined self-organizing map/hierarchical clustering) and distance statistics (Euclidean, Manhattan and cosine distance). Note the superior 'explained' variance fraction and CV performance of the PAM algorithm/cosine distance procedure.

__(B)__ Determination of the optimal cluster number by the bend of the total within-cluster sum-of-squares curve. The dashed vertical line indicates the chosen number of PAM clusters.

__(C)__ Importance of particular clustering features was determined by comparing the 'explained' clustering variances of the original clustering structure with the clustering objects with randomly re-shuffled clustering features.

\newpage

```{r fig-clust-diff, fig.width = 7.086614166, fig.height = 4.724409444, fig.cap = 'Differences in study variable between the participant clusters.'}

suppl_figures$clust_diff$plot

```

__Supplementary Figure S\@ref(fig:fig-clust-diff). Differences in study variable between the participant clusters.__

Training Innsbruck (IBK) cohort participants were clustered as presented in __Figure 3__ and __Supplementary Figure S\@ref(fig:fig-cluster-qc)__. Cluster assignment of the test Linz/Vienna (LZ/W) cohort participants was accomplished by k-nearest neighbor label propagation procedure. Differences in the study variables (__Supplementary Table S\@ref(tab:tab-study-variables)__) between the clusters were determined by Mann-Whitney test with r effect size statistic or by $\chi^2$ test with Cramer V effect size statistic for numeric and categorical features, respectively. P values were adjusted for multiple testing with Benjamini-Hochberg method (pFDR). 
Significance (pFDR) and effect size are presented in scatter plots. Each point represents one study parameter, parameters significantly different between the clusters are highlighted in red. Parameters found significant in both cohorts are labeled with their names. The significance cutoff is depicted as a dashed line. Numbers of participants assigned to the clusters are presented under the plots.
CI: cardiac index; mPAP: mean pulmonary arterial pressure; NT-pro-BNP: N terminal pro brain natriuretic peptide; PVR: pulmonary vascular resistance; RAA: right atrial area; SMWD: six minute walking distance; mPAP: mean pulmonary arterial pressure; RDW: red blood cell distribution width; mRAP: mean right atrial pressure; FPHR: French pulmonary hypertension register; SPAHR: Swedish pulmonary arterial hypertension register; COMPERA: comparative, prospective registry of newly initiated therapies for pulmonary hypertension; mRASP: modified risk assessment score of PAH.

\newpage

# References
